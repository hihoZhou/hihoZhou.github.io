---
layout: post
title: v2ray
date: 2019-06-18
categories: blog
tags: [v2ray]
description: 搭建v2ray服务

---

## 简单配置

### 服务端

直接使用shell安装脚本，最好用`root`用户，使用非root用户会报错 

```bash
bash <(curl -L -s https://install.direct/go.sh)
```

![install](/source/images/v2ray/1.png)


备份初始配置文件并且修改

```bash
sudo cp /etc/v2ray/config.json /etc/v2ray/config.json.default
vim /etc/v2ray/config.json

```


```json
{
  "inbounds": [{
    "port": 11303,//设置服务端端口，到时候客户端链接需要通过该端口，按需要更改
    "protocol": "vmess",
    "settings": {
      "clients": [
        {
          "id": "f681f551-0c6a-443e-bf11-b57aa79b9313",//认证的id，客户端需要
          "level": 1,
          "alterId": 63 //客户端需要
        }
      ]
    }
  }],
  "outbounds": [{
    "protocol": "freedom",
    "settings": {}
  },{
    "protocol": "blackhole",
    "settings": {},
    "tag": "blocked"
  }],
  "routing": {
    "rules": [
      {
        "type": "field",
        "ip": ["geoip:private"],
        "outboundTag": "blocked"
      }
    ]
  }
}


```

启动服务端服务

```bash
sudo service v2ray start
```

查看状态

```bash
sudo service v2ray status
```

![status](/source/images/v2ray/2.png)


### 客户端

v2ray可以上游服务端，也可以作为下有客户端，所以我们本地直接在安装一个v2ray，本地的`outbounds`链接服务端的`inbounds`

在本地电脑同样使用shell安装

```bash
bash <(curl -L -s https://install.direct/go.sh)
```


备份初始配置文件并且修改

```bash
sudo cp /etc/v2ray/config.json /etc/v2ray/config.json.default
vim /etc/v2ray/config.json

```


```json
{
  "inbounds": [
      {
        "port": 1080,//本地端口
        "listen":"127.0.0.1",//本地地址
        "protocol": "socks",//协议
        "settings": {
            "auth": "noauth",
            "udp": true
        }
      }
  ],
  "outbounds": [
      {
        "protocol": "vmess",
        "settings": {
            "vnext": [
            {
              "address": "xxx.xxx.xxx.xxx",//服务端id
              "port": 11303,//服务端端口
              "users": [
                {
                  "id": "f681f551-0c6a-443e-bf11-b57aa79b9313",//服务端对应配置的id
                  "alterId": 63 //服务端对应配置的alterId
                }
              ]
            }
          ]
        }
      }
  ]
}


```

启动本地客户端服务

```bash
sudo service v2ray start
```

然后浏览器使用`SwitchyOmega`配置到1080端口，SOCKS5协议

![SwitchyOmega](/source/images/v2ray/3.png)

利用v2ray简单的科学上网已经可以实现了


## 开启mKCP和Mux

### mKCP

mKCP是一个基于UDP的传输协议，由KCP改进而来，它以更多的流量为代价，降低了网络延迟。

要使用mKCP，请打开config.json（服务端的配置文件一般在/etc/v2ray/config.json），在`客户端`的`outbound`和`服务端`的`inbound`中加入同一段

```

"streamSettings": {    
    "network": "kcp",    
    "kcpSettings": {      
        "mtu": 1350,      
        "tti": 20,      
        "uplinkCapacity": 12,//修改为你的实际下载速度或更大，单位为MB/s      
        "downlinkCapacity": 1000,      
        "congestion": false,      
        "readBufferSize": 1,      
        "writeBufferSize": 1,      
        "header": {        
            "type": "none"      
        }    
    }  
}


```

`uplinkCapacity` 和 `downlinkCapacity` 中较小值决定了传输的速率，最好一个为较大的数字，另一个为你的实际下载速度。

修改 `header` 的 `type` 可以把流量包进行伪装。
 
- "none" : 默认值，不进行伪装，发送的数据是没有特征的数据包。 
- "srtp" : 伪装成 SRTP 数据包，会被识别为视频通话数据（如 FaceTime）。 
- "utp" : 伪装成 uTP 数据包，会被识别为 BT 下载数据。 
- "wechat-video" : 伪装成微信视频通话的数据包。


### Mux

Mux是一种多路复用协议，有助于减少TCP连接数，提高性能。

开启Mux，只要在客户端配置文件的outbound加入一段，服务端会自动识别。


```
"mux": {    
    "enabled": true,    
    "concurrency": 8  
}
```


## 在已有的网站上伪装成HTTPS流量


### 服务端

1.打开文件 /etc/v2ray/config.json，在inbound中加入一小段：

```
"streamSettings": {    
  "network": "ws",    
  "wsSettings": {      
    "path": "/v2" //该路径可以自定义，但是要在Nginx、客户端中保持一致    
  }  
}
```

![4](/source/images/v2ray/4.png)



2.配置nginx

```

#提示百度等爬虫不收录
location = /robots.txt {
	allow all;
	log_not_found off;
	access_log off;
}

location /v2 #这里要与上面的路径一致    
{        
    proxy_redirect off;        
    proxy_pass http://127.0.0.1:11303; #端口与上面一致        
    proxy_http_version 1.1;        
    proxy_set_header Upgrade $http_upgrade;        
    proxy_set_header Connection "upgrade";        
    proxy_set_header Host $http_host;    
}
```

修改完后，保存并重启Nginx和V2Ray。


### 客户端

打开config.json，在outbound中加入一小段：

```
"streamSettings": {    
    "network": "ws",    
    "security": "tls",    
    "tlsSettings": {      
        "serverName": "v2raytest.ml"//填入你网站的域名    
    },    
    "wsSettings": {      
        "path": "/v2"//与上面的路径一致    
    }  
}

```


然后修改”settings” – “vnext” – “port”: 443


![5](/source/images/v2ray/5.png)


保存并重启V2Ray即可。

如果没有正常工作，在服务器终端里执行 setsebool -P httpd_can_network_connect 1 并重试。



## CDN

### 注册 Cloudflare
本次使用的 CDN 为 Cloudflare.com（复制在浏览器粘贴即可进入官网） 使用的 CDN 并不一定要求必须是 Cloudflare，
只要具备以下特点即可：
- 1. 支持 SSL（能够自带 SSL 更好，如果不自带但支持 SSL，那本机 VPS 上也要使用 SSL） 
- 2. 有海外节点

## 参考

- https://blog.gazer.win/essay/simple-v2ray-websocket-tls-cdn-example.html
- https://www.codercto.com/a/22204.html
